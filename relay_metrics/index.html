<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Metric protocol, aggregation and processing for Sentry."><meta name="keywords" content="rust, rustlang, rust-lang, relay_metrics"><title>relay_metrics - Rust</title><link rel="stylesheet" type="text/css" href="../normalize.css"><link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../light.css"  id="themeStyle"><link rel="stylesheet" type="text/css" href="../dark.css" disabled ><link rel="stylesheet" type="text/css" href="../ayu.css" disabled ><script id="default-settings"></script><script src="../storage.js"></script><script src="../crates.js"></script><noscript><link rel="stylesheet" href="../noscript.css"></noscript><link rel="shortcut icon" href="https://raw.githubusercontent.com/getsentry/relay/master/artwork/relay-icon.png"><style type="text/css">#crate-search{background-image:url("../down-arrow.svg");}</style></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="sidebar"><div class="sidebar-menu" role="button">&#9776;</div><a href='../relay_metrics/index.html'><div class='logo-container'><img src='https://raw.githubusercontent.com/getsentry/relay/master/artwork/relay-icon.png' alt='logo'></div></a><p class="location">Crate relay_metrics</p><div class="block version"><p>Version 21.7.0</p></div><div class="sidebar-elems"><a id="all-types" href="all.html"><p>See all relay_metrics's items</p></a><div class="block items"><ul><li><a href="#macros">Macros</a></li><li><a href="#structs">Structs</a></li><li><a href="#enums">Enums</a></li></ul></div><p class="location"></p><div id="sidebar-vars" data-name="relay_metrics" data-ty="mod" data-relpath="../"></div><script defer src="../sidebar-items.js"></script></div></nav><div class="theme-picker"><button id="theme-picker" aria-label="Pick another theme!" aria-haspopup="menu"><img src="../brush.svg" width="18" height="18" alt="Pick another theme!"></button><div id="theme-choices" role="menu"></div></div><nav class="sub"><form class="search-form"><div class="search-container"><div><select id="crate-search"><option value="All crates">All crates</option></select><input class="search-input" name="search" disabled autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"></div><button type="button" class="help-button">?</button>
                <a id="settings-menu" href="../settings.html"><img src="../wheel.svg" width="18" height="18" alt="Change settings"></a></div></form></nav><section id="main" class="content"><h1 class="fqn"><span class="in-band">Crate <a class="mod" href="">relay_metrics</a><button id="copy-path" onclick="copy_path(this)">⎘</button></span><span class="out-of-band"><span id="render-detail"><a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span><a class="srclink" href="../src/relay_metrics/lib.rs.html#1-113" title="goto source code">[src]</a></span></h1><div class="docblock"><p>Metric protocol, aggregation and processing for Sentry.</p>
<p>Metrics are high-volume values sent from Sentry clients, integrations, or extracted from errors
and transactions, that can be aggregated and queried over large time windows. As opposed to rich
errors and transactions, metrics carry relatively little context information in tags with low
cardinality.</p>
<h1 id="protocol" class="section-header"><a href="#protocol">Protocol</a></h1>
<p>Clients submit metrics in a <a href="struct.Metric.html">text-based protocol</a> based on StatsD. A sample submission
looks like this:</p>
<pre><code class="language-text">endpoint.response_time@ms:57|d|#route:user_index
endpoint.hits:1|c|#route:user_index
</code></pre>
<p>The metric type is part of its signature just like the unit. Therefore, it is allowed to reuse a
metric name for multiple metric types, which will result in multiple metrics being recorded.</p>
<h1 id="metric-envelopes" class="section-header"><a href="#metric-envelopes">Metric Envelopes</a></h1>
<p>To send one or more metrics to Relay, the raw protocol is enclosed in an envelope item of type
<code>metrics</code>:</p>
<pre><code class="language-text">{}
{&quot;type&quot;: &quot;metrics&quot;, &quot;timestamp&quot;: 1615889440, ...}
endpoint.response_time@ms:57|d|#route:user_index
...
</code></pre>
<p>The timestamp in the item header is used to send backdated metrics. If it is omitted,
the <code>received</code> time of the envelope is assumed.</p>
<h1 id="aggregation" class="section-header"><a href="#aggregation">Aggregation</a></h1>
<p>Relay accumulates all metrics in <a href="struct.Bucket.html">time buckets</a> before sending them onwards. Aggregation
is handled by the <a href="struct.Aggregator.html" title="Aggregator"><code>Aggregator</code></a>, which should be created once per Project Key (DSN). It flushes
aggregates in regular intervals, either shortly after their original time window has passed or
with a debounce delay for backdated submissions.</p>
<p><strong>Warning</strong>: With chained Relays submission delays accumulate.</p>
<p>Aggregate buckets are encoded in JSON with the following schema:</p>
<pre><code class="language-json">[
  {
    &quot;name&quot;: &quot;endpoint.response_time&quot;,
    &quot;unit&quot;: &quot;ms&quot;,
    &quot;value&quot;: [36, 49, 57, 68],
    &quot;type&quot;: &quot;d&quot;,
    &quot;timestamp&quot;: 1615889440,
    &quot;tags&quot;: {
      &quot;route&quot;: &quot;user_index&quot;
    }
  },
  {
    &quot;name&quot;: &quot;endpoint.hits&quot;,
    &quot;value&quot;: 4,
    &quot;type&quot;: &quot;c&quot;,
    &quot;timestamp&quot;: 1615889440,
    &quot;tags&quot;: {
      &quot;route&quot;: &quot;user_index&quot;
    }
  }
]
</code></pre>
<h1 id="ingestion" class="section-header"><a href="#ingestion">Ingestion</a></h1>
<p>Processing Relays write aggregate buckets into the ingestion Kafka stream. The schema is similar
to the aggregation payload, with the addition of scoping information:</p>
<pre><code class="language-json">[
  {
    &quot;org_id&quot;: 1,
    &quot;project_id&quot;: 42,
    &quot;name&quot;: &quot;endpoint.response_time&quot;,
    &quot;unit&quot;: &quot;ms&quot;,
    &quot;value&quot;: [36, 49, 57, 68],
    &quot;type&quot;: &quot;d&quot;,
    &quot;timestamp&quot;: 1615889440,
    &quot;tags&quot;: {
      &quot;route&quot;: &quot;user_index&quot;
    }
  },
  {
    &quot;org_id&quot;: 1,
    &quot;project_id&quot;: 42,
    &quot;name&quot;: &quot;endpoint.hits&quot;,
    &quot;value&quot;: 4,
    &quot;type&quot;: &quot;c&quot;,
    &quot;timestamp&quot;: 1615889440,
    &quot;tags&quot;: {
      &quot;route&quot;: &quot;user_index&quot;
    }
  }
]
</code></pre>
</div><h2 id="macros" class="section-header"><a href="#macros">Macros</a></h2>
<table><tr class="module-item"><td><a class="macro" href="macro.dist.html" title="relay_metrics::dist macro">dist</a></td><td class="docblock-short"><p>Creates a <a href="struct.DistributionValue.html" title="DistributionValue"><code>DistributionValue</code></a> containing the given arguments.</p>
</td></tr></table><h2 id="structs" class="section-header"><a href="#structs">Structs</a></h2>
<table><tr class="module-item"><td><a class="struct" href="struct.AggregateMetricsError.html" title="relay_metrics::AggregateMetricsError struct">AggregateMetricsError</a></td><td class="docblock-short"><p>Any error that may occur during aggregation.</p>
</td></tr><tr class="module-item"><td><a class="struct" href="struct.Aggregator.html" title="relay_metrics::Aggregator struct">Aggregator</a></td><td class="docblock-short"><p>A collector of <a href="struct.Metric.html" title="Metric"><code>Metric</code></a> submissions. Every project key (DSN) has one Aggregator.</p>
</td></tr><tr class="module-item"><td><a class="struct" href="struct.AggregatorConfig.html" title="relay_metrics::AggregatorConfig struct">AggregatorConfig</a></td><td class="docblock-short"><p>Parameters used by the <a href="struct.Aggregator.html" title="Aggregator"><code>Aggregator</code></a>.</p>
</td></tr><tr class="module-item"><td><a class="struct" href="struct.Bucket.html" title="relay_metrics::Bucket struct">Bucket</a></td><td class="docblock-short"><p>An aggregation of metric values by the <a href="struct.Aggregator.html" title="Aggregator"><code>Aggregator</code></a>.</p>
</td></tr><tr class="module-item"><td><a class="struct" href="struct.DistributionIter.html" title="relay_metrics::DistributionIter struct">DistributionIter</a></td><td class="docblock-short"><p>An iterator over distribution entries in a <a href="struct.DistributionValue.html" title="DistributionValue"><code>DistributionValue</code></a>.</p>
</td></tr><tr class="module-item"><td><a class="struct" href="struct.DistributionValue.html" title="relay_metrics::DistributionValue struct">DistributionValue</a></td><td class="docblock-short"><p>A distribution of values within a <a href="struct.Bucket.html" title="Bucket"><code>Bucket</code></a>.</p>
</td></tr><tr class="module-item"><td><a class="struct" href="struct.DistributionValuesIter.html" title="relay_metrics::DistributionValuesIter struct">DistributionValuesIter</a></td><td class="docblock-short"><p>An iterator over all individual values in a <a href="struct.DistributionValue.html" title="DistributionValue"><code>DistributionValue</code></a>.</p>
</td></tr><tr class="module-item"><td><a class="struct" href="struct.FlushBuckets.html" title="relay_metrics::FlushBuckets struct">FlushBuckets</a></td><td class="docblock-short"><p>A message containing a vector of buckets to be flushed.</p>
</td></tr><tr class="module-item"><td><a class="struct" href="struct.GaugeValue.html" title="relay_metrics::GaugeValue struct">GaugeValue</a></td><td class="docblock-short"><p>A snapshot of values within a <a href="struct.Bucket.html" title="Bucket"><code>Bucket</code></a>.</p>
</td></tr><tr class="module-item"><td><a class="struct" href="struct.InsertMetrics.html" title="relay_metrics::InsertMetrics struct">InsertMetrics</a></td><td class="docblock-short"><p>A message containing a list of <a href="struct.Metric.html" title="Metric"><code>Metric</code></a>s to be inserted into the aggregator.</p>
</td></tr><tr class="module-item"><td><a class="struct" href="struct.MergeBuckets.html" title="relay_metrics::MergeBuckets struct">MergeBuckets</a></td><td class="docblock-short"><p>A message containing a list of <a href="struct.Bucket.html" title="Bucket"><code>Bucket</code></a>s to be inserted into the aggregator.</p>
</td></tr><tr class="module-item"><td><a class="struct" href="struct.Metric.html" title="relay_metrics::Metric struct">Metric</a></td><td class="docblock-short"><p>A single metric value representing the payload sent from clients.</p>
</td></tr><tr class="module-item"><td><a class="struct" href="struct.ParseBucketError.html" title="relay_metrics::ParseBucketError struct">ParseBucketError</a></td><td class="docblock-short"><p>Error returned when parsing or serializing a <a href="struct.Bucket.html" title="Bucket"><code>Bucket</code></a>.</p>
</td></tr><tr class="module-item"><td><a class="struct" href="struct.ParseMetricError.html" title="relay_metrics::ParseMetricError struct">ParseMetricError</a></td><td class="docblock-short"><p>An error returned by <a href="struct.Metric.html#method.parse" title="Metric::parse"><code>Metric::parse</code></a> and <a href="struct.Metric.html#method.parse_all" title="Metric::parse_all"><code>Metric::parse_all</code></a>.</p>
</td></tr><tr class="module-item"><td><a class="struct" href="struct.ParseMetrics.html" title="relay_metrics::ParseMetrics struct">ParseMetrics</a></td><td class="docblock-short"><p>Iterator over parsed metrics returned from <a href="struct.Metric.html#method.parse_all" title="Metric::parse_all"><code>Metric::parse_all</code></a>.</p>
</td></tr><tr class="module-item"><td><a class="struct" href="struct.UnixTimestamp.html" title="relay_metrics::UnixTimestamp struct">UnixTimestamp</a></td><td class="docblock-short"><p>A unix timestamp (full seconds elapsed since 1970-01-01 00:00 UTC).</p>
</td></tr></table><h2 id="enums" class="section-header"><a href="#enums">Enums</a></h2>
<table><tr class="module-item"><td><a class="enum" href="enum.BucketValue.html" title="relay_metrics::BucketValue enum">BucketValue</a></td><td class="docblock-short"><p>The <a href="struct.Bucket.html#structfield.value">aggregated value</a> of a metric bucket.</p>
</td></tr><tr class="module-item"><td><a class="enum" href="enum.DurationPrecision.html" title="relay_metrics::DurationPrecision enum">DurationPrecision</a></td><td class="docblock-short"><p>Time duration units used in <a href="enum.MetricUnit.html#variant.Duration" title="MetricUnit::Duration"><code>MetricUnit::Duration</code></a>.</p>
</td></tr><tr class="module-item"><td><a class="enum" href="enum.MetricType.html" title="relay_metrics::MetricType enum">MetricType</a></td><td class="docblock-short"><p>The type of a <a href="enum.MetricValue.html" title="MetricValue"><code>MetricValue</code></a>, determining its aggregation and evaluation.</p>
</td></tr><tr class="module-item"><td><a class="enum" href="enum.MetricUnit.html" title="relay_metrics::MetricUnit enum">MetricUnit</a></td><td class="docblock-short"><p>The <a href="struct.Metric.html#structfield.unit">unit</a> of measurement of a metric <a href="struct.Metric.html#structfield.value">value</a>.</p>
</td></tr><tr class="module-item"><td><a class="enum" href="enum.MetricValue.html" title="relay_metrics::MetricValue enum">MetricValue</a></td><td class="docblock-short"><p>The <a href="struct.Metric.html#structfield.value">typed value</a> of a metric.</p>
</td></tr></table></section><section id="search" class="content hidden"></section><div id="rustdoc-vars" data-root-path="../" data-current-crate="relay_metrics" data-search-index-js="../search-index.js" data-search-js="../search.js"></div>
    <script src="../main.js"></script></body></html>